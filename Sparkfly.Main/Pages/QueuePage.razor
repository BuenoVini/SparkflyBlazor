@page "/queue"
@using Sparkfly.Main.Components
@using Sparkfly.Main.Data
@using Sparkfly.Main.Services

@inject SparkflyManager Sparkfly
@inject ProtectedSessionStorage ProtectedSession

<MudStack>
    <MudText Align="Align.Center" Typo="Typo.h5">Priority Queues</MudText>

    @if (_votes is not null)
    {
        @foreach (int i in Enumerable.Range(0, _votes.Count))
        {
            <MudText Align="Align.Center" Typo="Typo.h6">Priority @(i + 1)</MudText>

            @foreach (var vote in _votes[i])
            {
                @if (vote.Client.Id == _thisClient?.Id && !vote.IsOnSpotifyQueue)
                {
                    <TrackCard Track="vote.VotedTrack" Client="vote.Client" OnClickCallback="@RemoveVoteAsync" BtnFunc="TrackCard.BtnFunctionality.Remove" />
                }
                else
                {
                    <TrackCard Track="vote.VotedTrack" Client="vote.Client" />
                }
            }
        }
    }

</MudStack>

@code {
    private List<Queue<Vote>>? _votes;
    private Client? _thisClient;

    // TODO: make the page update alongside the Timer

    protected override async Task OnInitializedAsync()
    {
        _thisClient = (await ProtectedSession.GetAsync<Client>("this_client")).Value;
        _votes = Sparkfly.Votes;
    }

    private async Task RemoveVoteAsync(Track track)
    {
        if (_thisClient is not null)
        {
            Sparkfly.RemoveVote(track, _thisClient);
            _votes = Sparkfly.Votes;
            await InvokeAsync(StateHasChanged);     // NOTE: may not be necessary... see Blazor EventCallback with parameters
        }
    }
}
