@page "/welcome"

@using Sparkfly.Main.Services
@using Sparkfly.Main.Services.RequestApi

@inject SparkflyManager Sparkfly
@inject NavigationManager NavManager
@inject ProtectedLocalStorage LocalStorage
@inject IStringLocalizer<WelcomePage> Msg

<PageTitle>@Msg["welcome"]</PageTitle>

<MudStack Spacing="8">
    <MudText Typo="Typo.h3" Align="Align.Center">
        <bold>@Msg["welcome"]</bold>
    </MudText>

    <MudText Typo="Typo.h6" Align="Align.Center">
        @Msg["about_1"]
    </MudText>


    <MudDivider Class="p-16" />


    <MudText Typo="Typo.body1" Align="Align.Center">
        @Msg["about_2"]
    </MudText>
    <MudText Typo="Typo.body1" Align="Align.Center">
        @Msg["about_3"]
    </MudText>

    <MudTextField @bind-Value="_partyId" Label=@Msg["name_label"] HelperText=@Msg["name_helper"] Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Outlined.Edit" AdornmentColor="Color.Primary" />


    <MudDivider />


    <MudText Class="mb-n6" Typo="Typo.body1" Align="Align.Center">
        @Msg["guide_1"]
    </MudText>
    <MudButton  OnClick="@GuestSignIn" Variant="Variant.Filled" Color="Color.Primary">
        @Msg["btn_enter"]
    </MudButton>

    <MudText Class="mt-2 mb-n6" Typo="Typo.body1" Align="Align.Center">
        @Msg["guide_2"]
    </MudText>
    <MudButton OnClick="@SpotifySignIn" Variant="Variant.Filled" Color="Color.Success">
        @Msg["btn_spotify"]
    </MudButton>
</MudStack>


@code {
    private string? _partyId;

    private void SpotifySignIn()
    {
        string state = new Random().Next().ToString();
        LocalStorage.SetAsync("state", state);

        try
        {
            NavManager.NavigateTo(Sparkfly.SpotifySignInUri(state).ToString());
        }
        catch (Exception ex)
        {
            if (ex is SpotifyApiException || ex is HttpRequestException)
                NavManager.NavigateTo("/unhandled-error" + QueryString.Create("message", ex.Message));
            else
                throw;
        }
    }

    private void GuestSignIn() => NavManager.NavigateTo("/validate");
}
