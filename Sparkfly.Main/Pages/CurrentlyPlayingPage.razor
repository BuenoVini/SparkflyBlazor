@page "/currently-playing"

@using Sparkfly.Main.Components
@using Sparkfly.Main.Data
@using Sparkfly.Main.RequestAPI

@implements IDisposable

@inject Spotify spotify
@inject NavigationManager NavigationManager

<PageTitle>Listening to @currentTrack?.ArtistsNames[0]</PageTitle>

<MudStack>
    <MudText Align="Align.Center" Typo="Typo.h6">You are listening to:</MudText>

    @if (currentTrack is not null)
    {
        <MudPaper Class="pa-4" MaxWidth="350px">
            <MudImage Class="rounded-lg align-self-center" Fluid="true" Src=@currentTrack.CoverSizesUrl[(int)CoverSize.Medium] Alt="Album current playing" Elevation="25" />

            <MudDivider Class="my-4" DividerType="DividerType.Middle" />

            <MudText Align="Align.Center" Typo="Typo.body1">@currentTrack.SongName</MudText>
            <MudText Align="Align.Center" Typo="Typo.body2">@currentTrack.ArtistsNames[0]</MudText>
            <div class="d-flex justify-center mt-2">
                <MudText Typo="Typo.caption">Suggested by <strong>Tiffany</strong>!</MudText>
            </div>
        </MudPaper>

        <MudText Class="mt-4" Align="Align.Center" Typo="Typo.h6">Playing next: </MudText>

        <TrackCard Track="@currentTrack" />
    }

    @*@if (nextTrack is not null)
    {
        
    }*@

</MudStack>

@code {
    private Timer? timer;
    private Track? currentTrack;
    //private Track? nextTrack;

    protected override void OnInitialized()
    {
        timer = new Timer(async _ =>
        {
            try
            {
                currentTrack = await spotify.GetCurrentlyPlayingAsync();
                //nextTrack = await spotify.GetNextPlaying();

                await InvokeAsync(StateHasChanged);
            }
            catch (HttpRequestException e)
            {
                try
                {
                    if (e.StatusCode == HttpStatusCode.Unauthorized)
                        await spotify.RefreshAccessTokenAsync();
                    else
                        NavigationManager.NavigateTo("/unhandled-error");
                }
                catch (HttpRequestException)
                {
                    NavigationManager.NavigateTo("/unhandled-error");
                }
            }
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(15));
    }

    public void Dispose() => timer?.Dispose();  // TODO: make async ??
}